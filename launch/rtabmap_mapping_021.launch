<?xml version="1.0"?>

<launch>

  <!-- 0. House-keeping -->
  <arg   name="geotiff_map_file_path" default="$(find hector_geotiff)/maps"/>
  <param name="/use_sim_time"         value="false"/>

  <!-- Static TF: world â†’ map (keeps Hector & RViz happy) -->
  <node name="static_tf0" pkg="tf" type="static_transform_publisher"
        args="1 0 0 0 0 0 /world /map 100"/>

  <!-- Optional visualisation -->
  <node pkg="rviz" type="rviz" name="rviz"
        args="-d $(find hector_slam_launch)/rviz_cfg/mapping_demo.rviz"/>

  <!-- Hector 2-D SLAM (laser only, still useful for a 2-D occupancy map) -->
  <include file="$(find ros_x_habitat)/launch/hector_mapping_default.launch"/>

  <!-- 1. RGB-D topic synchroniser (split package name) -->
  <node pkg="nodelet" type="nodelet" name="rgbd_sync"
        args="standalone rtabmap_sync/rgbd_sync" output="screen">
    <remap from="rgb/image"       to="rgb"/>
    <remap from="depth/image"     to="depth"/>
    <remap from="rgb/camera_info" to="camera_info"/>
    <remap from="rgbd_image"      to="rgbd_image"/>  <!-- output -->
    <param name="approx_sync"     value="true"/>
  </node>

  <!-- 2) convert Odometry msg into TF odom->base_frame  -->
  <node pkg="tf" type="odometry_publisher" name="odom_tf_pub">
    <param name="odom_topic"    value="/odom"/>
    <param name="base_frame_id" value="base_frame"/>
    <param name="odom_frame_id" value="odom"/>
    <param name="use_msg_time" value="false"/>
  </node>
        
  <node pkg="topic_tools" type="transform" name="odom_relay_fix"
      args="/scanmatch_odom /odom nav_msgs/Odometry '(setattr(m.header, &quot;frame_id&quot;, &quot;odom&quot;), m)[1]'"/>

           
  <node pkg="tf" type="static_transform_publisher" name="cam_to_base"
        args="0 0 0 0 0 0  base_frame  laser  100"/>
      
  <!-- 2. RTAB-Map core (split pkg is rtabmap_slam) -->
  <node name="rtabmap" pkg="rtabmap_slam" type="rtabmap"
        output="screen" args="--delete_db_on_start">

    <!-- Input & frame settings -->
    <param name="frame_id"            value="base_frame"/>
    <param name="subscribe_depth"     value="false"/>
    <param name="subscribe_rgbd"      value="true"/>
    <param name="subscribe_scan"      value="true"/>
    <param name="queue_size"          value="10"/>

    <!-- <remap from="odom"       to="odom"/> -->
    <remap from="odom"       to="odom"/>
    <remap from="scan"       to="scan"/>
    <remap from="rgbd_image" to="rgbd_image"/>

    <!-- RTAB-Map tuning -->
    <param name="RGBD/NeighborLinkRefining"      value="true"/>
    <param name="RGBD/ProximityBySpace"          value="true"/>
    <param name="RGBD/AngularUpdate"             value="0.01"/>
    <param name="RGBD/LinearUpdate"              value="0.01"/>
    <param name="RGBD/OptimizeFromGraphEnd"      value="false"/>
    <param name="Grid/FromDepth"                 value="false"/>  <!-- use lidar -->
    <param name="Reg/Force3DoF"                  value="true"/>
    <param name="Reg/Strategy"                   value="1"/>      <!-- ICP -->
    <param name="Icp/VoxelSize"                  value="0.05"/>
    <param name="Icp/MaxCorrespondenceDistance"  value="0.1"/>
    <param name="RGBD/CreateOccupancyGrid" value="true"/>
  </node>

</launch>

